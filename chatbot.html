<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>Chatbot and Prescription Upload</title>
    <style>
    body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            font-family: Arial, sans-serif;
            color: #fff;
        }

    .headline {
    text-align: center;
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #00bfff;
    position: absolute; /* Add */
    top: 10px; /* Adjust as needed */
    left: 50%; /* Horizontally center */
    transform: translateX(-50%); /* Ensure proper centering */
}
/* MODAL CONTAINER */
.modal-container {
    position: fixed; /* Keeps modal on top */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 400px;
    background-color: #1a1a1a;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    padding: 20px;
    z-index: 1000;
    display: none; /* Hidden by default */
}

/* ACTIVE MODAL */
.modal-container.active {
    display: block;
}

/* CLOSE BUTTON */
.close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: transparent;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
}

/* TEXTAREA */
textarea {
    background-color: #333;
    color: white;
    width: 100%;
    padding: 10px;
    outline: none;
    border: 1px solid rgba(105, 105, 105, 0.5);
    border-radius: 8px;
    resize: none;
    font-size: 14px;
}

/* BUTTON */
.submit {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    background-color: #00bfff;
    color: white;
    font-size: 16px;
    border: none;
    cursor: pointer;
    margin-top: 10px;
}

.submit:hover {
    background-color: #008cba;
}

        .chat-container {
            position: relative;
            max-width: 600px;
            width: 100%;
            background-color: #1a1a1a;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            padding: 20px;
            overflow: hidden;
        }

        .menu {
    display: flex;
    align-items: center;
    gap: 10px; /* Space between buttons */
}

.menu-header, .urgent-care-btn,.sos-btn {
    background-color: #2575fc;
    min-width: 120px;
    color: white;
    font-size: 16px;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    width: 140px; /* Ensure both buttons are the same size */
    text-align: center;
}

.urgent-care-btn {
    background-color: #ff9900; /* Orange color for Urgent Care */
}

.urgent-care-btn:hover {
    background-color: #ff7700;
}

.menu-header:hover {
    background-color: #6a11cb;
}

        .menu-header:hover {
            background-color: #6a11cb;
        }

        .menu-content {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
        }

        .menu-item {
            background-color: #2b2b2b;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
        }

        .menu-item:hover {
            background-color: #6a11cb;
        }

        .section {
            display: none;
        }

        .active {
            display: block !important;
        }
        .sos-btn {
        background-color: red;
        color: white;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
}

.sos-btn:hover {
    background-color: darkred;
}


        .chat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .chat-header img {
            width: 50px;
            height: 50px;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 24px;
            color: #00bfff;
        }

    .chat-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        background-color: #2b2b2b;
        padding: 15px;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        max-height: 400px;
        margin-bottom: 10px;
        color: #fff;
    }
    .chat-messages::-webkit-scrollbar {
    width: 8px; /* Width of the scrollbar */
}
.dynamic-progress-bar {
    width: 100%; /* Make it full width */
    max-width: 300px; /* Adjust width as needed */
    height: 20px; /* Increase height for better visibility */
    background-color: #ddd;
    border-radius: 5px;
    position: relative;
    overflow: hidden;
}

.dynamic-progress-bar span {
    display: block;
    height: 100%;
    background-color: #4caf50; /* Green progress */
    text-align: center;
    color: white;
    font-weight: bold;
    line-height: 20px; /* Center text vertically */
    white-space: nowrap; /* Prevent text wrapping */
    transition: width 0.3s ease-in-out; /* Smooth animation */
}


.chat-messages::-webkit-scrollbar-track {
    background: #2b2b2b; /* Scrollbar track background */
    border-radius: 10px; /* Rounded edges */
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #00bfff; /* Scrollbar thumb (draggable part) */
    border-radius: 10px; /* Rounded edges */
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #008cba; /* Thumb color on hover */
}
    .chat-message {
        padding: 10px;
        margin: 5px 0;
        border-radius: 10px;
        line-height: 1.4;
        max-width: 70%; /* Ensures the message width is limited */
    }

    .user-message {
        background-color: #2575fc;
        color: #fff;
        text-align: right;
        margin-left: auto; /* Aligns user message to the right */
    }

    .bot-message {
        background-color: #6a11cb;
        color: #fff;
        margin-right: auto; /* Aligns bot message to the left */
    }

    .chat-input {
        display: flex;
        gap: 10px;
    }

    #chat-input {
        flex: 1;
        padding: 10px;
        border: 1px solid rgba(105, 105, 105, 0.5);
        border-radius: 10px;
        background-color: #333;
        color: #fff;
    }

    #chat-input:focus {
        outline: none;
        border-color: #00bfff;
    }
    .loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-top: 20px;
}

.button-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.feature-button {
    padding: 10px 20px;
    font-size: 14px;
    border: none;
    background-color: #4CAF50;
    color: white;
    border-radius: 5px;
    cursor: pointer;
}

.feature-button:hover {
    background-color: #45a049;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #00bfff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.loading-spinner p {
    color: #fff;
    margin-top: 10px;
    font-size: 14px;
}


    #send-btn {
        padding: 10px 20px;
        background-color: #00bfff;
        color: #fff;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #send-btn:hover {
        background-color: #00bfff96;
    }
    
        
        .constant-upload-container {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            background-color: #2b2b2b;
        }
    
        h2, h3 {
            text-align: center;
            color: #00bfff;
        }
    
        input[type="file"] {
            display: none;
        }
    
        label {
            display: inline-block;
            padding: 10px 20px;
            background-color: #00bfff;
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
    
        label:hover {
            background-color: #00bfff96;
        }
    
        .progress-bar {
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
    
        .progress-bar span {
            display: block;
            height: 100%;
            background-color: #00bfff;
            width: 0;
            transition: width 0.3s ease;
        }
    
        .doctor-list {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
    
        .doctor-item {
            padding: 15px;
            background-color: #444547;
            color: #fff;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
    
        .doctor-item:hover {
            transform: scale(1.05);
            background-color: #6a11cb;
        }
    
        .calendly-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1a1a1a;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            padding: 20px;
            z-index: 1000;
        }
    
        .calendly-iframe {
            width: 100%;
            height: 400px;
            border: none;
            margin-bottom: 15px;
        }
    
        .return-to-chat-btn,
        .back-to-doctorlist-btn {
            padding: 10px 20px;
            background-color: #00bfff;
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
        }
    
        .return-to-chat-btn:hover,
        .back-to-doctorlist-btn:hover {
            background-color: #00bfff96;
        }
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            font-family: Arial, sans-serif;
          }
      
          .form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            width: 100%;
            padding: 25px;
            border-radius: 20px;
            background-color: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
          }
      
          .title {
            font-size: 28px;
            font-weight: 600;
            color: #00bfff;
          }
      
          .form textarea {
            background-color: #333;
            color: #fff;
            width: 100%;
            padding: 10px;
            outline: 0;
            border: 1px solid rgba(105, 105, 105, 0.397);
            border-radius: 10px;
            resize: none;
          }
      
          .form textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
          }
      
          .submit {
            border: none;
            outline: none;
            padding: 10px;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            background-color: #00bfff;
            cursor: pointer;
          }
      
          .submit:hover {
            background-color: #00bfff96;
          }
      
          .output {
            background-color: #333;
            padding: 10px;
            border-radius: 10px;
            color: #00bfff;
            font-size: 14px;
            word-wrap: break-word;
            max-height: 300px; /* Limit max height */
            overflow-y: auto; /* Scrollable for long text */
            border: 1px solid rgba(105, 105, 105, 0.397);
            transition: max-height 0.3s ease;
          }
    </style>
    </head>
<body>    
    <div>
        <h1 class="headline">Cure Connect</h1>
    </div>
    <div class="background" id="background"></div>
    <div class="chat-container">
        <div class="chat-header">
            <img src="bot.png" alt="Bot Icon">
            <h3>Cure Connect Bot</h3>
        </div>

        <div class="menu">
            <div class="menu-header"onclick="toggleMenu()"><i class="fas fa-bars"></i> Menu</div>
            <button class="urgent-care-btn" onclick="triggerUrgentCare()"><i class="fas fa-ambulance"></i> Urgent Care</button>
            <button class="sos-btn"><i class="fas fa-exclamation-triangle"></i> SOS</button>
            <div class="menu-content" id="menu-content">
                <div class="menu-item" data-section="prescription"><i class="fas fa-file-medical"></i> Upload Prescription Anytime</div>
                <div class="menu-item" data-section="translate"><i class="fas fa-language"></i> Translate Symptoms</div>
                <div class="menu-item" data-section="pharmacy"><i class="fas fa-capsules"></i> Pharmacy</div>
            </div>
        </div>
        <div id="loading-spinner" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p>Bot is thinking...</p>
        </div>
        
<!-- Prescription Modal -->
<div id="prescription" class="modal-container">
    <button class="close-btn" onclick="closeSection('prescription')">X</button>
    <h3>Upload Prescription</h3>
    <input type="file" id="prescription-upload" />
    <label for="prescription-upload" class="upload-label">Choose File and Send</label>
    <p id="constant-upload-status"></p>
    <div id="constant-progress-bar" class="progress-bar">
        <span id="constant-progress"></span>
    </div>
</div>

<!-- Translate Modal -->
<div id="translate" class="modal-container">
    <button class="close-btn" onclick="closeSection('translate')">X</button>
    <h3>Translate Symptoms</h3>
    <textarea id="localInput" placeholder="Enter symptoms..." rows="4"></textarea>
    <button class="submit" onclick="translateText()">Translate</button>
    <div id="translationOutput" class="output">Translation will appear here...</div>
    <button class="submit" onclick="submitSymptoms()">Submit to casualty</button>
</div>

<!-- Pharmacy Modal -->
<div id="pharmacy" class="modal-container">
    <button class="close-btn" onclick="closeSection('pharmacy')">X</button>
    <h3>Pharmacy</h3>
    <button class="submit" onclick="window.location.href='pharmacy.html'">Go to Pharmacy</button>
</div>

        <div class="chat-section">
            <div id="chat-messages" class="chat-messages">
                <!-- Chat messages will appear here -->
            </div>
            <div class="chat-input">
                <textarea id="chat-input" placeholder="Type your message here..."></textarea>
                <button id="send-btn">Send</button>
            </div>
        </div>
    </div>
    <div id="doctor-list" class="doctor-list">
        <!-- Doctors will be displayed here dynamically -->
    </div>
</div>




<script>
    function triggerUrgentCare() {
        // Assuming you have a function to send messages to the chatbot
        displayMessage("Please specify your urgent care situation right now","bot","true");
    }
    
function toggleMenu() {
            const menuContent = document.getElementById('menu-content');
            menuContent.style.display = menuContent.style.display === 'block' ? 'none' : 'block';
        }

        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', event => {
                const sectionId = event.target.getAttribute('data-section');
                showSection(sectionId);
            });
        });

function showSection(sectionId) {
    // Hide all modals
    const modals = document.querySelectorAll('.modal-container');
    modals.forEach(modal => modal.classList.remove('active'));

    // Show the selected modal
    const selectedModal = document.getElementById(sectionId);
    selectedModal.classList.add('active');
}

function closeSection(sectionId) {
    const modal = document.getElementById(sectionId);
    modal.classList.remove('active');
}

// Update menu item click to trigger the modal
document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', event => {
        const sectionId = event.target.getAttribute('data-section');
        showSection(sectionId);
    });
});

        function translateText() {
            const text = document.getElementById("localInput").value.trim();
            if (!text) {
                alert("Please enter text to translate.");
                return;
            }
            console.log("Translation feature triggered.");
        }

        function submitSymptoms() {
            const translatedText = document.getElementById("translationOutput").textContent;
            if (!translatedText || translatedText === "Translation will appear here...") {
                alert("Please translate symptoms before submitting.");
                return;
            }
            console.log("Symptoms submitted.");
        }
    
    let selectedDoctor = "";
    // Chatbot functionality
    const chatMessages = document.getElementById("chat-messages");
    const chatInput = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");

    
    

    // Prescription upload functionality (Triggered by the chatbot)
    const prescriptionUpload = document.getElementById("prescription-upload");
    const progressBar = document.getElementById("constant-progress-bar");
    const progressSpan = document.getElementById("constant-progress");
    const uploadStatus = document.getElementById("constant-upload-status");
    const uploadContainer = document.getElementById("upload-container");

    // Constant upload functionality
    const constantPrescriptionUpload = document.getElementById("prescription-upload");
    const constantProgressBar = document.getElementById("constant-progress-bar");
    const constantProgressSpan = document.getElementById("constant-progress");
    const constantUploadStatus = document.getElementById("constant-upload-status");

    const API_URL = "http://127.0.0.1:5000/boot/chatbot";
    const PRESCRIPTION_URL = "http://127.0.0.1:5000/boot/upload_presp";
    const LOGOUT_URL="http://127.0.0.1:5000/boot/logout"

    /*const doctorCalendlyLinks = {
        "DR ARYA": "https://calendly.com/rohanbaiju/dr-rohan-consultation",
        "DR ROHAN": "https://calendly.com/rohanbaiju/dr-rohan-consultation",
    };*/
    // Get JWT token from localStorage
    const jwtToken = localStorage.getItem("jwtToken");
console.log("JWT TOKEN IS FROM CHATBOT.HTML", jwtToken);

// Handle sending messages in the chatbot when the Send button is clicked
sendBtn.addEventListener("click", () => {
    const message = chatInput.value.trim();
    
    if (message) {
        // Handle logout
        if (message.toLowerCase() === "logout") {
            handleLogout();
        } 
        else if (message.toLowerCase() === "clear all" || message.toLowerCase() === "clear too" || message.toLowerCase() === "clear" ) {
            handleClearChat();
        } 
        else {
            // Handle regular message
            sendChatMessage(message);
        }
    }
});

// Handle the Enter key press to send a message
chatInput.addEventListener("keydown", (event) => {
    if (event.key === "Enter" && !event.shiftKey) { // If "Enter" key is pressed without Shift
        event.preventDefault(); // Prevents a new line from being added
        sendBtn.click(); // Trigger the click event of the "Send" button
    }
});

// Function to handle logout
function handleLogout() {
    fetch(LOGOUT_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${jwtToken}` // Pass the JWT token if needed
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.response) {
            displayMessage(data.response, "bot");
            console.log("translation reached");
        } else {
            console.error("Unexpected response format:", data);
            displayMessage("Sorry, something went wrong. Please try again.", "bot");
        }
    })
    .catch(error => {
        console.error("Error during logout:", error);
    });
}

// Function to handle clearing the chat
function handleClearChat() {
    const chatMessages = document.getElementById("chat-messages");
    chatMessages.innerHTML = ''; // Clear the chat container
    displayMessage("Chat cleared.", "bot"); // Optional confirmation message
}

// Function to send a regular chat message
function sendChatMessage(message) {
    displayMessage(message, "user");
    chatInput.value = "";
    
    const loadingSpinner = document.getElementById("loading-spinner");
    loadingSpinner.style.display = "flex";

    fetch(API_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${jwtToken}`
        },
        body: JSON.stringify({ message })
    })
    .then(response => response.json())
    .then(data => {
        loadingSpinner.style.display = "none";
        console.log("Backend response received:", data);

        if (data.response) {
            // Convert newlines to <br> for HTML formatting
            const formattedMessage = data.response.replace(/\n/g, "<br>");

            if (data.ugcare === "TRUE" && data.urgentcare_chosen_doc_name) {
                console.log("Urgent care flag is TRUE, doctor:", data.urgentcare_chosen_doc_name);
                displayMessage(formattedMessage, "bot", true);
                displayUrgentCareMessage(data.urgentcare_chosen_doc_name, data.caseINTENT);
            } else if (data.buttons && data.buttons.length > 0) {
                // Display message with buttons
                dispvv(formattedMessage, "bot", data.buttons, true);
            } else {
                // Display normal bot messages without buttons
                displayMessage(formattedMessage, "bot", true);
            }
        } else if (data.doctors) {
            console.log("Doctors data received:", data.doctors);
            displayMessage("Here is the list of available doctors:", "bot");
            displayDoctorList(data.doctors);
        } else {
            console.error("Unexpected response format:", data);
            displayMessage("Sorry, something went wrong. Please try again.", "bot");
        }

        if (data.show_upload) {
            displayUploadButton();
        }
    })
    .catch(error => {
        console.error("Error:", error);
        loadingSpinner.style.display = "none";
        displayMessage("Sorry, something went wrong. Try logging in again, Check if backend is ON", "bot");
    });
}


    
    
// Function to display the urgent care message and the contact button
function displayUrgentCareMessage(doctorName, case_intent) {
    console.log("Doctor name in urgent care (raw):", doctorName);
    console.log("CASE INTENTTT IN URGENTCAREFUNCTION:", case_intent);

    // Remove HTML tags from doctorName, if any
    const sanitizedDoctorName = doctorName.replace(/<[^>]*>/g, ""); // Strips out any HTML tags
    console.log("Sanitized doctor name:", sanitizedDoctorName);
    const upperCaseDoctorName = sanitizedDoctorName.toUpperCase();
    const buttonMessage = document.createElement("div");
    buttonMessage.classList.add("chat-message", "bot-message");
    const caseIntent = case_intent;

    // Create the new "Send Email" button
    const sendEmailButton = document.createElement("button");
    sendEmailButton.textContent = `Click here to contact  ${upperCaseDoctorName}`;
    sendEmailButton.style.backgroundColor = "#4CAF50"; // Change the background color if needed
    sendEmailButton.style.color = "white";
    sendEmailButton.style.border = "none";
    sendEmailButton.style.padding = "10px 20px";
    sendEmailButton.style.borderRadius = "5px";
    sendEmailButton.style.cursor = "pointer";

    sendEmailButton.addEventListener("click", () => {
        // Trigger the email sending action when the button is clicked
        sendEmailToDoctor(sanitizedDoctorName, caseIntent);
    });

    // Append the button to the message
    buttonMessage.appendChild(sendEmailButton);
    chatMessages.appendChild(buttonMessage);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    console.log("Send Email button appended to chatMessages.");
}

// Function to handle email sending action
function sendEmailToDoctor(doctorName, caseIntent) {
    const sanitizedIntentName = caseIntent.replace(/<[^>]*>/g, ""); // Strips out any HTML tags
    console.log("Sanitized doctor name:", sanitizedIntentName);
    const jwtToken = localStorage.getItem('jwtToken');
    console.log("CASE in email send", caseIntent);
    console.log("URGENT DOC NAME IN sendEmail", doctorName);
    const upperCaseDoctorName = doctorName.toUpperCase();

    // Send POST request to backend to send email and retrieve Zoom join URL
    fetch('http://127.0.0.1:5000/boot/urgentsendemail', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
        },
        body: JSON.stringify({
            doctor_name: doctorName,
            case_intent: sanitizedIntentName.toUpperCase()
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => { throw new Error(data.error || 'Failed to send email') });
        }
        return response.json();
    })
    .then(data => {
        console.log("Email sent successfully:", data);

        // Display confirmation message
        displayMessage("Your urgent care request has been sent to " + upperCaseDoctorName, "bot");

        // Extract join_url correctly from response
        if (data.response) {
            seeZoom(data.response,upperCaseDoctorName); // Pass the join_url to seeZoom function
        } else {
            console.error("No join URL received from the backend.");
        }
    })
    .catch(error => {
        console.error("Error sending email:", error);
        displayMessage(error, "bot");
    });
}



    // Function to display Zoom meeting button and embed iframe on click
    function seeZoom(joinUrl,upperCaseDoctorName) {
        const buttonMessage = document.createElement("div");
        buttonMessage.classList.add("chat-message", "bot-message");
        const sendEmailButton = document.createElement("button");
        sendEmailButton.textContent = `Click here to JOIN THE MEET WITH  ${upperCaseDoctorName}`;
        sendEmailButton.style.backgroundColor = "#4CAF50"; // Change the background color if needed
        sendEmailButton.style.color = "white";
        sendEmailButton.style.border = "none";
        sendEmailButton.style.padding = "10px 20px";
        sendEmailButton.style.borderRadius = "5px";
        sendEmailButton.style.cursor = "pointer";
        console.log("HEREE 2222")
        sendEmailButton.addEventListener("click", () => {
            // Trigger the email sending action when the button is clicked
            sendEmailButton.remove(); // Remove the button after clicking
    
            // Create iframe element
            const zoomIframe = document.createElement("iframe");
            zoomIframe.src = joinUrl;
            zoomIframe.allow = "camera; microphone; fullscreen";
            zoomIframe.style.width = "50%";
            zoomIframe.style.height = "400px";
            zoomIframe.style.border = "none";
            zoomIframe.style.marginTop = "10px";
    
            // Append iframe to chat messages container
            chatMessages.appendChild(zoomIframe);
            displayMessage("Hope your urgent care request gets taken care, type <b>CLEAR</b> or <b>CLEAR ALL</b> to clear the chat to start interaction again", "bot","true");
            
        });
        
        // Append the button to the message
        buttonMessage.appendChild(sendEmailButton);
        chatMessages.appendChild(buttonMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    
        console.log("ZOOM button appended to chatMessages.");
        // Event listener for button click
        
    }
    
    
    // Function to display messages
        function displayMessage(message, sender, isHtml = false) {
            const messageContainer = document.createElement("div");
            messageContainer.classList.add("chat-message", sender === "user" ? "user-message" : "bot-message");

    // Add bot icon if the sender is "bot"
            if (sender === "bot") {
            const botIcon = document.createElement("img");
            botIcon.src = "bot.png"; // Ensure this path is correct
            botIcon.alt = "Bot Icon";
            botIcon.style.width = "30px"; // Adjust size as needed
            botIcon.style.height = "30px";
            botIcon.style.marginRight = "10px"; // Space between icon and message
            botIcon.style.borderRadius = "50%"; // Circle-shaped icon
            messageContainer.appendChild(botIcon);
        }

        const messageElement = document.createElement("span"); // Use a span for the text
        if (isHtml) {
            messageElement.innerHTML = message;
        } else {
            messageElement.textContent = message;
        }

        messageContainer.appendChild(messageElement);
        chatMessages.appendChild(messageContainer);
        chatMessages.scrollTop = chatMessages.scrollHeight;
     }

    // Function to display messages (with buttons)
        function dispvv(message, sender, buttons = [], isHtml = false) {
        const messageContainer = document.createElement("div");
        messageContainer.classList.add("chat-message", sender === "user" ? "user-message" : "bot-message");

    // Add bot icon if the sender is "bot"
        if (sender === "bot") {
            const botIcon = document.createElement("img");
            botIcon.src = "bot.png"; // Ensure this path is correct
            botIcon.alt = "Bot Icon";
            botIcon.style.width = "30px"; // Adjust size as needed
            botIcon.style.height = "30px";
            botIcon.style.marginRight = "10px"; // Space between icon and message
            botIcon.style.borderRadius = "50%"; // Circle-shaped icon
            messageContainer.appendChild(botIcon);
        }

        const messageElement = document.createElement("span"); // Use a span for the text
        if (isHtml) {
            messageElement.innerHTML = message;
        } else {
            messageElement.textContent = message;
        }

        messageContainer.appendChild(messageElement);

    // If there are buttons, create them
        if (buttons.length > 0) {
            const buttonContainer = document.createElement("div");
            buttonContainer.classList.add("button-container");

            buttons.forEach(button => {
                const buttonElement = document.createElement("button");
                buttonElement.classList.add("feature-button");
                buttonElement.textContent = button.text;
                buttonElement.onclick = () => handleButtonClick(button.text); // Define what happens on button click
                buttonContainer.appendChild(buttonElement);
        });

            messageContainer.appendChild(buttonContainer);
     }

    chatMessages.appendChild(messageContainer);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Function to handle button click events
function handleButtonClick(value) {
    console.log("Button clicked:", value);
    // Depending on the button clicked, send a relevant message or perform an action
    sendChatMessage(value); // Example of sending the button value as the next message
}

   






    function displayDoctorList(doctors) {
        const doctorListContainer = document.getElementById("doctor-list");
        doctorListContainer.innerHTML = ""; // Clear existing list

        // Show the doctor list widget if it's hidden
        doctorListContainer.style.visibility = "visible"; // Ensure it's visible
        doctorListContainer.style.display = "grid"; // Use grid display
        window.doctorCalendlyLinks = {};
        doctors.forEach(doctor => {
            const doctorItem = document.createElement("div");
            doctorItem.classList.add("doctor-item");
            doctorItem.textContent = `${doctor.name} (${doctor.speciality})`;
            doctorItem.onclick = () => selectDoctor(doctor.name,doctor.bookurls); // Select doctor when clicked
            console.log(doctor.bookurls)
            doctorListContainer.appendChild(doctorItem);
            window.doctorCalendlyLinks[doctor.name] = doctor.bookurls;
        });
    }

    // Function to handle doctor selection
    function selectDoctor(doctorName,calendlyLink) {
        selectedDoctor = doctorName; // Store selected doctor name
        openCalendlyWidget(doctorName,calendlyLink); // Open Calendly widget
    }

    function openCalendlyWidget(doctorName,calendlyLink) {
        //const calendlyLink = doctorCalendlyLinks[doctorName];

        if (!calendlyLink) {
            alert("Calendly link not available for this doctor.");
            return; // Exit if no link exists for the doctor
        }

        const background = document.getElementById("background");
        const doctorListContainer = document.getElementById("doctor-list");

        // Show the background blur
        background.style.visibility = "visible";

        // Create the popup modal for Calendly
        const calendlyPopup = document.createElement('div');
        calendlyPopup.classList.add('calendly-popup');

        // Create the iframe for Calendly
        const calendlyIframe = document.createElement('iframe');
        calendlyIframe.src = `${calendlyLink}?embed_domain=yourwebsite.com&embed_type=Inline`;
        calendlyIframe.classList.add('calendly-iframe');

        // Create the return to chat button
        const returnToChatButton = document.createElement('button');
        returnToChatButton.classList.add('return-to-chat-btn');
        returnToChatButton.textContent = 'Click here to return to chat';
        returnToChatButton.onclick = () => {
            document.body.removeChild(calendlyPopup); // Remove the Calendly popup
            background.style.visibility = "hidden"; // Hide the background blur
            doctorListContainer.style.visibility = "hidden"; // Hide the doctor list

            // Trigger the confirmation message from the chatbot
            if (selectedDoctor) {
                const confirmationMessage = `Your appointment with  ${selectedDoctor} is successfully scheduled. Check the email in which you booked for further updates.`;
                displayMessage(confirmationMessage, "bot");
                selectedDoctor = ""; // Reset the selected doctor
            }
        };

        // Create the back to doctor list button
        const backToDoctorListButton = document.createElement('button');
        backToDoctorListButton.classList.add('back-to-doctorlist-btn');
        backToDoctorListButton.textContent = 'Back to Doctor List';
        backToDoctorListButton.onclick = () => {
            document.body.removeChild(calendlyPopup); // Remove the Calendly popup
            background.style.visibility = "hidden"; // Hide the background blur
            doctorListContainer.style.visibility = "visible"; // Show the doctor list again
        };

        calendlyPopup.appendChild(calendlyIframe);
        calendlyPopup.appendChild(returnToChatButton);
        calendlyPopup.appendChild(backToDoctorListButton);

        // Append the popup modal to the body
        document.body.appendChild(calendlyPopup);

        // Hide the doctor list when Calendly is open
        doctorListContainer.style.visibility = "hidden";
    }

    // Function to parse the response and extract doctor info


    // Function to display upload button in chat
    function displayUploadButton() {
        const buttonMessage = document.createElement("div");
        buttonMessage.classList.add("chat-message", "bot-message");
    
        // Create upload button
        const uploadButton = document.createElement("button");
        uploadButton.textContent = "Upload Prescription here and send";
        uploadButton.style.backgroundColor = "#2d87f0";
        uploadButton.style.color = "white";
        uploadButton.style.border = "none";
        uploadButton.style.padding = "10px 20px";
        uploadButton.style.borderRadius = "5px";
        uploadButton.style.cursor = "pointer";
    
        // Create dynamic progress bar
        const progressBarContainer = document.createElement("div");
        progressBarContainer.classList.add("progress-bar");
        progressBarContainer.classList.add("dynamic-progress-bar"); // Add class here
        progressBarContainer.style.backgroundColor = "#ccc";
        progressBarContainer.style.borderRadius = "5px";
        progressBarContainer.style.marginTop = "10px";
        progressBarContainer.style.display = "none";  // Initially hidden
    
        const progressBar = document.createElement("span");
        progressBar.id = "dynamic-progress";
        progressBar.style.display = "block";
        progressBar.style.height = "10px";
        progressBar.style.width = "0%";
        progressBar.style.backgroundColor = "#2d87f0";
        progressBar.style.borderRadius = "5px";
        
        progressBarContainer.appendChild(progressBar);
    
        // Create status message element
        const constantUploadStatus = document.createElement("div");
        constantUploadStatus.style.marginTop = "10px"; // Adds space below progress bar
        constantUploadStatus.textContent = "";  // Initial empty text
    
        uploadButton.addEventListener("click", () => {
            // Create file input dynamically when the button is clicked
            const dynamicPrescriptionUpload = document.createElement("input");
            dynamicPrescriptionUpload.type = "file";
            dynamicPrescriptionUpload.style.display = "none"; // Hide the file input
    
            // Attach event listener for file selection
            dynamicPrescriptionUpload.addEventListener("change", (event) => {
                const file = event.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append("file", file);
                    
                    // Show the progress bar when file selection starts
                    progressBarContainer.style.display = "block";
                    constantUploadStatus.textContent = "Uploading...";  // Show uploading status
    
                    // Handle the file upload
                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", PRESCRIPTION_URL, true);
                    xhr.setRequestHeader("Authorization", `Bearer ${jwtToken}`);
    
                    // Update the progress bar during the upload
                    xhr.upload.onprogress = function (e) {
                        if (e.lengthComputable) {
                            const progress = (e.loaded / e.total) * 100;
                            progressBar.style.width = progress + "%"; // Update the progress bar width
                        }
                    };
    
                    // Handle completion of the upload
                    xhr.onload = function () {
                        if (xhr.status === 200) {
                            // Parse the backend response
                            const response1 = JSON.parse(xhr.responseText);
                            // Display success message
                            progressBar.style.width = "100%"; // Complete the progress bar
                            constantUploadStatus.textContent = "Upload successful!";  // Set success message
                            setTimeout(() => {
                                progressBarContainer.style.display = "none"; // Hide the progress bar after completion
                            }, 1000);
                            displayMessage(`Prescription Summary: ${response1.prescription_summary}`, "bot", true);  // Display summary
                        } else {
                            const response1 = JSON.parse(xhr.responseText);
                            const errorMessage = response1.error || "Login error has occurred";
                            constantUploadStatus.textContent = `Error: ${errorMessage}`; // Show error message
                            progressBar.style.width = "0%"; // Reset progress bar
                        }
                    };
    
                    // Send the form data (file) via the request
                    xhr.send(formData);
                }
            });
    
            // Trigger the file input when the button is clicked
            dynamicPrescriptionUpload.click();
        });
    
        // Append button, progress bar, and status message to chat message
        buttonMessage.appendChild(uploadButton);
        buttonMessage.appendChild(progressBarContainer);
        buttonMessage.appendChild(constantUploadStatus); // Add the status message here
        chatMessages.appendChild(buttonMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function translateText() {
        const text = document.getElementById("localInput").value.trim();
  
        if (!text) {
          alert("Please enter text to translate.");
          return;
        }
  
        fetch('http://127.0.0.1:5000/boot/translaterr', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${jwtToken}` 
          },
          body: JSON.stringify({ text }),
        })
        .then(response => response.json())
        .then(data => {
          const output = document.getElementById("translationOutput");
          if (data.translated_text) {
            output.textContent = data.translated_text;
  
            // Dynamically expand the height if needed
            output.style.maxHeight = "300px"; 
          } else {
            output.textContent = "Error: " + (data.error || "Translation failed.");
          }
        })
        .catch(err => {
          alert("An error occurred: " + err.message);
        });
      }
  
    function submitSymptoms() {
        const translatedText = document.getElementById("translationOutput").textContent;
  
        if (!translatedText || translatedText === "Translation will appear here...") {
          alert("Please translate symptoms before submitting.");
          return;
        }
  
        fetch('http://127.0.0.1:5000/boot/submit-symptoms', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${jwtToken}` 
          },
          body: JSON.stringify({ symptoms: translatedText }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert("Symptoms submitted successfully!");
          } else {
            alert("Failed to submit symptoms. Please try again.");
          }
        })
        .catch(err => {
          alert("An error occurred: " + err.message);
        });
      }

      



    // Handle constant prescription upload (Triggered by the constant upload button, as well as chatbot dynamic button)
    constantPrescriptionUpload.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append("file", file);
            
            if (constantProgressBar) {
                constantProgressBar.style.display = "block";
            } else {
                console.error("Element with ID 'constant-progress-bar' not found.");
            }
            constantProgressBar.style.display = "block";  // Show progress bar
            constantProgressSpan.style.width = "0%";     // Reset progress bar width
            constantUploadStatus.textContent = "Uploading...";  // Show uploading status

            const xhr = new XMLHttpRequest();
            xhr.open("POST", PRESCRIPTION_URL, true);
            xhr.setRequestHeader("Authorization", `Bearer ${jwtToken}`);

            // Update the progress bar during the upload (if it's a slower upload)
            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    const progress = (e.loaded / e.total) * 100;
                    constantProgressSpan.style.width = progress + "%";  // Update the progress bar width
                
                    if (window.dynamicProgressBar) {
                        window.dynamicProgressBar.style.width = progress + "%";
                        window.dynamicProgressBar.textContent = Math.round(progress) + "%"; // Show text percentage
                    } else {
                        console.log("Progress bar not found!");
                    }                
                } 
                else {
                    console.log("Progress not computable");
                }

            };

            // Handle completion of the upload
            xhr.onload = function () {
                if (xhr.status === 200) {
                    // Parse the backend response
                    const response1 = JSON.parse(xhr.responseText);
                    
                    // Display success message
                    constantUploadStatus.textContent = "Prescription uploaded successfully!";
                    
                    // Access the file path and prescription summary from the response
                    const filePath = response1.file_path;
                    const prescriptionSummary = response1.prescription_summary;

                    // Display the file path and the prescription summary as a constant upload message
                    //displayMessage(`File Path: ${filePath}`, "bot");
                    displayMessage(`Prescription Summary: ${prescriptionSummary}`, "bot", true);  // Render HTML content in summary
                } else {
                    const response1 = JSON.parse(xhr.responseText);
                    const errorMessage = response1.error || "Login error has occured";
                    displayMessage(`Error is: ${errorMessage}`, "bot");
                    // Display success message
                    constantUploadStatus.textContent = "Upload Failed";
                    
                }
                constantProgressBar.style.display = "none";  // Hide progress bar after upload is complete
            };

            // Send the form data (file) via the request
            xhr.send(formData);
        }
    });
    
</script>

</body>
</html>
